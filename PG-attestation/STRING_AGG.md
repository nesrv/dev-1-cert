


–§—É–Ω–∫—Ü–∏—è `CROSSTAB()` –≤ PostgreSQL ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞—Ç—å **—Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É (pivot table)**, –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞—è —Å—Ç—Ä–æ–∫–∏ –≤ **–∫–æ–ª–æ–Ω–∫–∏**, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Excel PivotTable. –û–Ω–∞ –≤—Ö–æ–¥–∏—Ç –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ **`tablefunc`**, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏—Ç—å.

---

## üîß 1. –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å `tablefunc`

```sql
CREATE EXTENSION IF NOT EXISTS tablefunc;
```

---

## üìä 2. –ü—Ä–∏–º–µ—Ä –∑–∞–¥–∞—á–∏

–î–æ–ø—É—Å—Ç–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥–∞–∂:

```sql
CREATE TABLE sales (
    employee TEXT,
    month TEXT,
    amount NUMERIC
);
```

### –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

```sql
INSERT INTO sales VALUES
('Alice', 'Jan', 100),
('Alice', 'Feb', 150),
('Bob',   'Jan', 200),
('Bob',   'Feb', 250),
('Charlie', 'Jan', 300);
```

---

## üìå 3. –ü—Ä–æ—Å—Ç–æ–π `CROSSTAB`

–ú—ã —Ö–æ—Ç–∏–º –ø–æ–≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫–∏ ‚Äî —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –±—ã–ª –≤ —Å—Ç—Ä–æ–∫–µ, –∞ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü ‚Äî –≤ –∫–æ–ª–æ–Ω–∫–µ.

### üìò –°–∏–Ω—Ç–∞–∫—Å–∏—Å:

```sql
SELECT *
FROM crosstab(
  $$SELECT employee, month, amount FROM sales ORDER BY 1,2$$
) AS ct(employee TEXT, jan NUMERIC, feb NUMERIC);
```

### üü¢ –†–µ–∑—É–ª—å—Ç–∞—Ç:

| employee | jan | feb  |
| -------- | --- | ---- |
| Alice    | 100 | 150  |
| Bob      | 200 | 250  |
| Charlie  | 300 | NULL |

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

* `crosstab()` **–Ω–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è** ‚Äî –Ω—É–∂–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ —É–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ (`jan`, `feb`, –∏ —Ç.–¥.).
* –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É Charlie –Ω–µ—Ç Feb) –±—É–¥—É—Ç **NULL**.

---

## üìå 4. `CROSSTAB` —Å –¥–≤—É–º—è –≤—Ö–æ–¥–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–≥–∏–±–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–¥–∞—Ç—å **–ø–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤**, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ç–æ—Ä–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä:

```sql
SELECT *
FROM crosstab(
  $$SELECT employee, month, amount FROM sales ORDER BY 1,2$$,
  $$SELECT DISTINCT month FROM sales ORDER BY month$$
) AS ct(employee TEXT, jan NUMERIC, feb NUMERIC);
```

---

## üß† –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `CROSSTAB()`:

* –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–≤–æ–¥–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü (Pivot Table).
* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤.
* –ü–æ–≤–æ—Ä–æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏.

---

–•–æ—á–µ—à—å –ø—Ä–∏–º–µ—Ä —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–æ–ª–æ–Ω–æ–∫ (—á–µ—Ä–µ–∑ PL/pgSQL) –∏–ª–∏ —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π (`SUM`, `COUNT`)?



–§—É–Ω–∫—Ü–∏—è `STRING_AGG()` –≤ PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ –≤ –æ–¥–Ω—É, —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º ‚Äî –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–∞ –¥–ª—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤.

---

## üìò –ü—Ä–∏–º–µ—Ä –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ `sales`

–î–æ–ø—É—Å—Ç–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å —Ç–∞–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞:

```sql
CREATE TABLE sales (
    id SERIAL PRIMARY KEY,
    employee TEXT,
    region TEXT,
    amount NUMERIC
);
```

### –î–∞–Ω–Ω—ã–µ:

```sql
INSERT INTO sales (employee, region, amount) VALUES
('Alice', 'East', 100),
('Alice', 'East', 200),
('Bob',   'West', 300),
('Bob',   'West', 400),
('Charlie', 'East', 500);
```

---

## üîπ –ü—Ä–∏–º–µ—Ä 1: —Å–ø–∏—Å–æ–∫ —Å—É–º–º –ø–æ –∫–∞–∂–¥–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É

```sql
SELECT employee,
       STRING_AGG(amount::TEXT, ', ') AS all_sales
FROM sales
GROUP BY employee;
```

üü¢ **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

| employee | all\_sales |
| -------- | ---------- |
| Alice    | 100, 200   |
| Bob      | 300, 400   |
| Charlie  | 500        |

---

## üîπ –ü—Ä–∏–º–µ—Ä 2: —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º

```sql
SELECT region,
       STRING_AGG(DISTINCT employee, ', ' ORDER BY employee) AS employees
FROM sales
GROUP BY region;
```

üü¢ **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

| region | employees      |
| ------ | -------------- |
| East   | Alice, Charlie |
| West   | Bob            |

---

## üîπ –ü—Ä–∏–º–µ—Ä 3: –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ HTML-—Å–ø–∏—Å–∫–∞

```sql
SELECT region,
       '<ul><li>' || STRING_AGG(employee, '</li><li>') || '</li></ul>' AS html_list
FROM sales
GROUP BY region;
```

---

## üß† –û–±—â–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:

```sql
STRING_AGG(expression, delimiter [ORDER BY ...])
```

* `expression` ‚Äî —á—Ç–æ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å (–æ–±—ã—á–Ω–æ —Ç–µ–∫—Å—Ç).
* `delimiter` ‚Äî —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `', '`).
* `ORDER BY` ‚Äî –µ—Å–ª–∏ –≤–∞–∂–µ–Ω –ø–æ—Ä—è–¥–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∞–≥—Ä–µ–≥–∞—Ç–µ.

---
