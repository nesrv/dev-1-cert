### –ö—É—Ä—Å–æ—Ä—ã –≤ PostgreSQL

**–ö—É—Ä—Å–æ—Ä** –≤ PostgreSQL ‚Äî —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç **–ø–æ—Å—Ç—Ä–æ—á–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞**. –ö—É—Ä—Å–æ—Ä—ã –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω—ã, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫, –∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏—Ö –≤—Å–µ –≤ –ø–∞–º—è—Ç—å —Å—Ä–∞–∑—É.

---

### üìå –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä—ã:

* –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º –æ–±—ä—ë–º–æ–º –¥–∞–Ω–Ω—ã—Ö.
* –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–æ—à–∞–≥–æ–≤–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏ –≤ —Ü–∏–∫–ª–µ.
* –í–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä –∏ —Ñ—É–Ω–∫—Ü–∏–π `PL/pgSQL`.

---

## üîß –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞

```plpgsql
DECLARE cursor_name CURSOR FOR select_query;
```

### üîÅ –†–∞–±–æ—Ç–∞ —Å –∫—É—Ä—Å–æ—Ä–æ–º:

1. **DECLARE** ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞.
2. **OPEN** ‚Äî –æ—Ç–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞.
3. **FETCH** ‚Äî –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.
4. **CLOSE** ‚Äî –∑–∞–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞.

---

## ‚úÖ –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–æ–π –∫—É—Ä—Å–æ—Ä

```sql
DO $$
DECLARE
    emp_record RECORD;
    emp_cursor CURSOR FOR SELECT id, name FROM employees;
BEGIN
    OPEN emp_cursor;
    LOOP
        FETCH emp_cursor INTO emp_record;
        EXIT WHEN NOT FOUND;

        RAISE NOTICE 'ID: %, Name: %', emp_record.id, emp_record.name;
    END LOOP;
    CLOSE emp_cursor;
END;
$$ LANGUAGE plpgsql;
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

* –û–±—ä—è–≤–ª—è–µ—Ç—Å—è –∫—É—Ä—Å–æ—Ä `emp_cursor`, –≤—ã–±–∏—Ä–∞—é—â–∏–π `id` –∏ `name` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `employees`.
* –ö—É—Ä—Å–æ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è.
* –ò–∑ –Ω–µ–≥–æ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è —Å—Ç—Ä–æ–∫–∏ –ø–æ –æ–¥–Ω–æ–π.
* –í—ã–≤–æ–¥–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.
* –ö—É—Ä—Å–æ—Ä –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è.

---

## ‚úÖ –ü—Ä–∏–º–µ—Ä 2: –ö—É—Ä—Å–æ—Ä —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º

```sql
DO $$
DECLARE
    emp_record RECORD;
    emp_cursor CURSOR (dept_id INT) FOR
        SELECT id, name FROM employees WHERE department_id = dept_id;
BEGIN
    OPEN emp_cursor(2);  -- –ø–µ—Ä–µ–¥–∞—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
    LOOP
        FETCH emp_cursor INTO emp_record;
        EXIT WHEN NOT FOUND;

        RAISE NOTICE 'ID: %, Name: %', emp_record.id, emp_record.name;
    END LOOP;
    CLOSE emp_cursor;
END;
$$ LANGUAGE plpgsql;
```

---

## ‚úÖ –ü—Ä–∏–º–µ—Ä 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –≤ —Ö—Ä–∞–Ω–∏–º–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä–µ

```sql
CREATE OR REPLACE PROCEDURE process_employees()
LANGUAGE plpgsql
AS $$
DECLARE
    rec RECORD;
    cur CURSOR FOR SELECT id, name FROM employees;
BEGIN
    OPEN cur;
    LOOP
        FETCH cur INTO rec;
        EXIT WHEN NOT FOUND;

        -- –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏: –≤—ã–≤–æ–¥
        RAISE NOTICE 'Employee: %, %', rec.id, rec.name;
    END LOOP;
    CLOSE cur;
END;
$$;
```

**–í—ã–∑–æ–≤:**

```sql
CALL process_employees();
```

---

## üßπ –ö—É—Ä—Å–æ—Ä –∫–∞–∫ REF CURSOR (–≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏)

```sql
CREATE OR REPLACE FUNCTION get_employees_cursor()
RETURNS REFCURSOR AS $$
DECLARE
    ref refcursor;
BEGIN
    OPEN ref FOR SELECT * FROM employees;
    RETURN ref;
END;
$$ LANGUAGE plpgsql;
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```sql
BEGIN;
SELECT get_employees_cursor();  -- –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∫—É—Ä—Å–æ—Ä–∞
FETCH ALL IN "<cursor_name>";   -- –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
COMMIT;
```

---

## üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

| –ö–æ–º–∞–Ω–¥–∞   | –û–ø–∏—Å–∞–Ω–∏–µ                          |
| --------- | --------------------------------- |
| `DECLARE` | –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞                |
| `OPEN`    | –û—Ç–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞                  |
| `FETCH`   | –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏                  |
| `MOVE`    | –ü—Ä–æ–ø—É—Å–∫ —Å—Ç—Ä–æ–∫–∏                    |
| `CLOSE`   | –ó–∞–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞                  |
| `FOR`     | –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ –∫—É—Ä—Å–æ—Ä—É –≤ `FOR`-—Ü–∏–∫–ª–µ |

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ:

* –ö—É—Ä—Å–æ—Ä—ã —Ç—Ä–µ–±—É—é—Ç `BEGIN`/`COMMIT`, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–Ω–µ PL/pgSQL.
* –ë–µ–∑ `CLOSE` –∫—É—Ä—Å–æ—Ä –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º –∏ –±—É–¥–µ—Ç —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã.

---

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –ø–æ–∫–∞–∂—É –ø—Ä–∏–º–µ—Ä –∫—É—Ä—Å–æ—Ä–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç—Ä–æ–∫. –•–æ—Ç–∏—Ç–µ —Ç–∞–∫–æ–π?
